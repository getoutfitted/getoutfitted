machine:
  services:
    - docker

dependencies:
  override:
    - bash .getoutfitted/clone-packages.sh
    - docker build -f .getoutfitted/docker/prod.dockerfile -t getoutfitted/getoutfitted:latest .

test:
  override:
    - docker-compose -f .getoutfitted/docker/docker-compose.test.yml up -d; sleep 15
    - curl --retry 10 --retry-delay 5 -v http://localhost

deployment:
  development:
    branch: development
    commands:
      - docker tag getoutfitted/getoutfitted:latest getoutfitted/getoutfitted:staging-$CIRCLE_BUILD_NUM
      - docker tag getoutfitted/getoutfitted:latest getoutfitted/getoutfitted:staging
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push getoutfitted/getoutfitted:staging-$CIRCLE_BUILD_NUM
      - docker push getoutfitted/getoutfitted:staging
  release:
    branch: master
    commands:
      - docker tag getoutfitted/getoutfitted:latest getoutfitted/getoutfitted:$CIRCLE_BUILD_NUM
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push getoutfitted/getoutfitted:$CIRCLE_BUILD_NUM
      - docker push getoutfitted/getoutfitted:latest
